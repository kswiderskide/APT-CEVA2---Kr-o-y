<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CEVA2 - Manager PRO</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEq-AGhrBol0dkthbxNiH9MwSY-BMrD9s&libraries=geometry,directions"></script>
    
    <style>
        :root { --bg: #0b1120; --card: #1e293b; --blue: #38bdf8; --green: #22c55e; --red: #ef4444; --gold: #fbbf24; --text: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        button { cursor: pointer; user-select: none; }

        /* PASEK ZMIAN (PRZEWIJANY) */
        .top-nav { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; min-height: 50px; flex-shrink: 0; background: var(--bg); z-index: 10; }
        .btn-nav { background: var(--card); color: #aaa; border: 1px solid #444; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1rem; white-space: nowrap; flex: 1; }
        .btn-nav.active { background: var(--blue); color: black; border-color: var(--blue); box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }

        /* INFO BOX */
        .info-box { background: var(--card); text-align: center; padding: 15px; border-radius: 20px; margin: 5px 0 10px 0; border: 2px solid #444; flex-shrink: 0; }
        #stop-name { font-size: 2.2rem; color: var(--blue); margin: 0; font-weight: 900; line-height: 1.1; text-transform: uppercase; }
        #timer { font-size: 4.5rem; font-weight: 900; margin: 5px 0; line-height: 1; color: var(--green); }
        .sub-timer { font-size: 1.2rem; color: var(--gold); font-weight: bold; }

        /* MAPA */
        #map-container { flex: 1; width: 100%; border-radius: 15px; border: 2px solid var(--blue); margin-bottom: 10px; position: relative; overflow: hidden; }
        #map { width: 100%; height: 100%; background: #222; }

        /* STEROWANIE */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 70px; flex-shrink: 0; margin-bottom: 10px; }
        .btn-big { background: var(--card); color: white; border: 1px solid #444; border-radius: 15px; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; text-transform: uppercase; }
        #btn-next { background: var(--card); border: 2px solid var(--blue); color: var(--blue); }

        /* START OVERLAY */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .start-btn { width: 160px; height: 160px; border-radius: 50%; background: var(--blue); color: white; border: none; font-size: 1.8rem; font-weight: bold; box-shadow: 0 0 30px var(--blue); }
        .gear-btn { position: absolute; bottom: 30px; right: 30px; font-size: 2.5rem; background: none; border: none; opacity: 0.5; }

        /* PIN */
        #pin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 20000; flex-direction: column; justify-content: center; align-items: center; }
        .keypad { display: grid; grid-template-columns: repeat(3, 85px); gap: 15px; margin-top: 30px; }
        .key { width: 85px; height: 85px; background: var(--card); border: 1px solid #666; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: white; font-weight: bold; }

        /* ADMIN */
        #admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 15000; padding: 15px; overflow-y: auto; box-sizing: border-box; }
        .edit-row { background: var(--card); padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #555; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .edit-input { background: black; color: white; border: 1px solid var(--blue); padding: 10px; font-size: 1rem; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        .btn-action { width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; border: none; font-weight: bold; color: white; font-size: 1.1rem; }

        /* BANNER */
        #picker-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: var(--gold); color: black; padding: 25px; text-align: center; font-weight: 900; font-size: 1.2rem; z-index: 99999; }
    </style>
</head>
<body>

    <div id="picker-banner">KLIKNIJ NA MAPIE ABY ZAPISAƒÜ PUNKT</div>

    <div id="start-overlay">
        <button class="start-btn" onclick="startApp()">START</button>
        <button class="gear-btn" onclick="openPin()">‚öôÔ∏è</button>
    </div>

    <div id="pin-overlay">
        <div id="pin-dots" style="color:var(--blue); font-size:4rem; height:60px; letter-spacing:10px;"></div>
        <div class="keypad">
            <div class="key" onclick="typePin('1')">1</div><div class="key" onclick="typePin('2')">2</div><div class="key" onclick="typePin('3')">3</div>
            <div class="key" onclick="typePin('4')">4</div><div class="key" onclick="typePin('5')">5</div><div class="key" onclick="typePin('6')">6</div>
            <div class="key" onclick="typePin('7')">7</div><div class="key" onclick="typePin('8')">8</div><div class="key" onclick="typePin('9')">9</div>
            <div class="key" style="color:red" onclick="clearPin()">C</div><div class="key" onclick="typePin('0')">0</div><div class="key" onclick="closePin()">X</div>
        </div>
    </div>

    <div id="admin-panel">
        <h2 style="color:var(--blue); margin-top:0;">EDYCJA TRASY</h2>
        <select id="route-select" onchange="loadEditor()" style="width:100%; padding:15px; background:black; color:white; border:1px solid var(--blue); border-radius:8px; font-size:1.1rem; margin-bottom:15px;"></select>
        <div id="editor-list"></div>
        <button class="btn-action" style="background:var(--blue)" onclick="addStop()">+ DODAJ PRZYSTANEK</button>
        <button class="btn-action" style="background:var(--green)" onclick="saveAndExit()">ZAPISZ I WYJD≈π</button>
        <button class="btn-action" style="background:var(--gold); color:black" onclick="genGithub()">GENERUJ KOD</button>
    </div>

    <div class="top-nav" id="nav-buttons"></div>

    <div class="info-box">
        <div id="stop-name">≈ÅADOWANIE...</div>
        <div id="timer">--</div>
        <div class="sub-timer">GPS: <span id="gps-timer">--</span></div>
    </div>

    <div id="map-container"><div id="map"></div></div>

    <div class="controls">
        <button class="btn-big" onclick="changeStop(-1)">POPRZEDNI</button>
        <button class="btn-big" id="btn-next" onclick="changeStop(1)">NASTƒòPNY</button>
    </div>

    <script>
        // --- KONFIGURACJA ---
        const PIN_CODE = "1234";
        let currentPin = "";
        
        // --- BAZA DANYCH (WSZYSTKIE TRASY) ---
        let schedules = {
            "06:00": [
                { "n": "RACULKA", "t": "04:47", "la": 51.93288, "ln": 15.54993 },
                { "n": "WAZ√ìW", "t": "04:55", "la": 51.94536, "ln": 15.52031 },
                { "n": "CENTRUM", "t": "04:58", "la": 51.94313, "ln": 15.50797 },
                { "n": "SOBKOWIAKA", "t": "05:05", "la": 51.96132, "ln": 15.49857 },
                { "n": "SULECH√ìW", "t": "05:25", "la": 52.08334, "ln": 15.62666 },
                { "n": "BRAMA 1", "t": "05:50", "la": 52.09099, "ln": 15.64957 },
                { "n": "BRAMA 2", "t": "06:00", "la": 52.09410, "ln": 15.66049 }
            ],
            "10:00": [
                { "n": "RACULKA", "t": "08:47", "la": 51.93288, "ln": 15.54993 },
                { "n": "WAZ√ìW", "t": "08:55", "la": 51.94536, "ln": 15.52031 },
                { "n": "CENTRUM", "t": "08:58", "la": 51.94313, "ln": 15.50797 },
                { "n": "SOBKOWIAKA", "t": "09:05", "la": 51.96132, "ln": 15.49857 },
                { "n": "SULECH√ìW", "t": "09:25", "la": 52.08334, "ln": 15.62666 },
                { "n": "BRAMA 1", "t": "09:50", "la": 52.09099, "ln": 15.64957 },
                { "n": "BRAMA 2", "t": "10:00", "la": 52.09410, "ln": 15.66049 }
            ],
            "12:00": [
                { "n": "RACULKA", "t": "10:40", "la": 51.93288, "ln": 15.54993 },
                { "n": "WAZ√ìW", "t": "10:50", "la": 51.94536, "ln": 15.52031 },
                { "n": "CENTRUM", "t": "10:53", "la": 51.94313, "ln": 15.50797 },
                { "n": "SOBKOWIAKA", "t": "11:00", "la": 51.96132, "ln": 15.49857 },
                { "n": "SULECH√ìW", "t": "11:25", "la": 52.08334, "ln": 15.62666 },
                { "n": "BRAMA 1", "t": "11:50", "la": 52.09099, "ln": 15.64957 },
                { "n": "BRAMA 2", "t": "12:00", "la": 52.09410, "ln": 15.66049 }
            ],
            "14:00": [
                { "n": "RACULKA", "t": "12:35", "la": 51.93288, "ln": 15.54993 },
                { "n": "WAZ√ìW", "t": "12:45", "la": 51.94536, "ln": 15.52031 },
                { "n": "CENTRUM", "t": "12:48", "la": 51.94313, "ln": 15.50797 },
                { "n": "SOBKOWIAKA", "t": "13:00", "la": 51.96132, "ln": 15.49857 },
                { "n": "SULECH√ìW", "t": "13:25", "la": 52.08334, "ln": 15.62666 },
                { "n": "BRAMA 1", "t": "13:50", "la": 52.09099, "ln": 15.64957 },
                { "n": "BRAMA 2", "t": "14:00", "la": 52.09410, "ln": 15.66049 }
            ],
            "16:00": [
                { "n": "RACULKA", "t": "14:35", "la": 51.93288, "ln": 15.54993 },
                { "n": "WAZ√ìW", "t": "14:45", "la": 51.94536, "ln": 15.52031 },
                { "n": "CENTRUM", "t": "14:48", "la": 51.94313, "ln": 15.50797 },
                { "n": "SOBKOWIAKA", "t": "15:00", "la": 51.96132, "ln": 15.49857 },
                { "n": "SULECH√ìW", "t": "15:25", "la": 52.08334, "ln": 15.62666 },
                { "n": "BRAMA 1", "t": "15:50", "la": 52.09099, "ln": 15.64957 },
                { "n": "BRAMA 2", "t": "16:00", "la": 52.09410, "ln": 15.66049 }
            ],
            "18:00": [
                { "n": "RACULKA", "t": "16:35", "la": 51.93288, "ln": 15.54993 },
                { "n": "WAZ√ìW", "t": "16:45", "la": 51.94536, "ln": 15.52031 },
                { "n": "CENTRUM", "t": "16:48", "la": 51.94313, "ln": 15.50797 },
                { "n": "SOBKOWIAKA", "t": "17:00", "la": 51.96132, "ln": 15.49857 },
                { "n": "SULECH√ìW", "t": "17:25", "la": 52.08334, "ln": 15.62666 },
                { "n": "BRAMA 1", "t": "17:50", "la": 52.09099, "ln": 15.64957 },
                { "n": "BRAMA 2", "t": "18:00", "la": 52.09410, "ln": 15.66049 }
            ],
            "POWR√ìT 08:15": [ { "n": "BRAMA 2", "t": "08:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 10:15": [ { "n": "BRAMA 2", "t": "10:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 12:15": [ { "n": "BRAMA 2", "t": "12:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 14:15": [ { "n": "BRAMA 2", "t": "14:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 16:15": [ { "n": "BRAMA 2", "t": "16:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 18:15": [ { "n": "BRAMA 2", "t": "18:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 20:15": [ { "n": "BRAMA 2", "t": "20:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
            "POWR√ìT 22:15": [ { "n": "BRAMA 2", "t": "22:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECH√ìW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ]
        };
        // -----------------------------------------------------------

        let currShift = "06:00";
        let idx = 0;
        let map, directionsService, directionsRenderer, userPos;
        let liveDelay = 0;
        let pickMode = false;
        let pickTarget = null;

        function startApp() {
            document.getElementById('start-overlay').style.display = 'none';
            initApp();
        }

        function initApp() {
            renderButtons();
            updateScreen();
            setInterval(updateScreen, 1000);

            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 51.93, lng: 15.54 },
                    zoom: 14,
                    mapTypeId: 'satellite',
                    disableDefaultUI: true
                });

                map.addListener("click", function(e) {
                    if (pickMode) {
                        let lat = e.latLng.lat().toFixed(5);
                        let lng = e.latLng.lng().toFixed(5);
                        schedules[pickTarget.r][pickTarget.i].la = parseFloat(lat);
                        schedules[pickTarget.r][pickTarget.i].ln = parseFloat(lng);
                        pickMode = false;
                        document.getElementById('picker-banner').style.display = 'none';
                        document.getElementById('admin-panel').style.display = 'block';
                        loadEditor();
                    } else {
                        openNavi();
                    }
                });

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#38bdf8', strokeWeight: 6 } });
                
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(function(p) {
                        userPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                        calculateRoute();
                    }, null, { enableHighAccuracy: true });
                }

            } catch (err) {
                console.error(err);
                alert("B≈ÇƒÖd API Map. Sprawd≈∫ klucz.");
            }
        }

        function calculateRoute() {
            if (!userPos || !directionsService || pickMode) return;
            let dest = { lat: schedules[currShift][idx].la, lng: schedules[currShift][idx].ln };
            
            directionsService.route({
                origin: userPos, destination: dest, travelMode: 'DRIVING'
            }, function(res, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(res);
                    liveDelay = Math.round(res.routes[0].legs[0].duration.value / 60);
                }
            });
        }

        function updateScreen() {
            if (pickMode) return;
            let s = schedules[currShift][idx];
            if (!s) return;

            document.getElementById('stop-name').innerText = s.n;
            let btnNext = document.getElementById('btn-next');
            
            if (idx >= schedules[currShift].length - 1) {
                btnNext.innerText = "ZAKO≈ÉCZ ‚úÖ";
                btnNext.style.background = "var(--green)";
                btnNext.style.color = "white";
            } else {
                btnNext.innerText = "NASTƒòPNY";
                btnNext.style.background = "var(--card)";
                btnNext.style.color = "var(--blue)";
            }

            if (s.t === "---") {
                let now = new Date();
                now.setMinutes(now.getMinutes() + liveDelay);
                let hh = String(now.getHours()).padStart(2, '0');
                let mm = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('timer').innerText = hh + ":" + mm;
                document.getElementById('timer').style.color = "var(--blue)";
                document.getElementById('gps-timer').innerText = liveDelay + " min";
            } else {
                let parts = s.t.split(':');
                let target = new Date();
                target.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
                let diff = Math.ceil((target - new Date()) / 60000);
                let el = document.getElementById('timer');
                el.innerText = diff + " min";
                el.style.color = diff < 0 ? "var(--red)" : "var(--green)";
                document.getElementById('gps-timer').innerText = (diff - liveDelay) + " min";
            }
        }

        function changeStop(dir) {
            if (dir === 1 && idx >= schedules[currShift].length - 1) {
                location.reload();
            } else if (schedules[currShift][idx + dir]) {
                idx += dir;
                updateScreen();
                calculateRoute();
            }
        }

        function openNavi() {
            let s = schedules[currShift][idx];
            let url = "https://www.google.com/maps/dir/?api=1&destination=" + s.la + "," + s.ln + "&travelmode=driving";
            window.open(url, '_blank');
        }

        function renderButtons() {
            let div = document.getElementById('nav-buttons');
            div.innerHTML = "";
            for (let k in schedules) {
                let btn = document.createElement('button');
                btn.className = 'btn-nav ' + (k === currShift ? 'active' : '');
                btn.innerText = k;
                btn.onclick = function() { currShift = k; idx = 0; renderButtons(); updateScreen(); calculateRoute(); };
                div.appendChild(btn);
            }
        }

        function openPin() { document.getElementById('pin-overlay').style.display = 'flex'; currentPin = ""; updateDots(); }
        function closePin() { document.getElementById('pin-overlay').style.display = 'none'; }
        function typePin(n) {
            currentPin += n; updateDots();
            if (currentPin.length === 4) {
                if (currentPin === PIN_CODE) { closePin(); openAdmin(); } 
                else { alert("Z≈ÅY PIN"); currentPin = ""; updateDots(); }
            }
        }
        function clearPin() { currentPin = ""; updateDots(); }
        function updateDots() { document.getElementById('pin-dots').innerText = "*".repeat(currentPin.length); }

        function openAdmin() {
            document.getElementById('admin-panel').style.display = 'block';
            let sel = document.getElementById('route-select');
            sel.innerHTML = "";
            for (let k in schedules) {
                let opt = document.createElement('option');
                opt.value = k; opt.innerText = k; sel.appendChild(opt);
            }
            loadEditor();
        }

        function loadEditor() {
            let r = document.getElementById('route-select').value;
            let div = document.getElementById('editor-list');
            div.innerHTML = "";
            schedules[r].forEach((s, i) => {
                let row = document.createElement('div');
                row.className = 'edit-row';
                row.innerHTML = 
                    '<div class="full-width"><b>'+(i+1)+'.</b> <input class="edit-input" value="'+s.n+'" onchange="schedules[\''+r+'\']['+i+'].n=this.value"></div>' +
                    '<div><input class="edit-input" value="'+s.t+'" onchange="schedules[\''+r+'\']['+i+'].t=this.value"></div>' +
                    '<div><button onclick="pickOnMap(\''+r+'\','+i+')" style="width:100%; background:var(--blue); border:none; padding:10px; color:white; border-radius:5px;">üìç GPS</button></div>' +
                    '<div class="full-width"><button onclick="delStop(\''+r+'\','+i+')" style="width:100%; background:var(--red); border:none; padding:10px; color:white; border-radius:5px;">USU≈É PRZYSTANEK</button></div>';
                div.appendChild(row);
            });
        }

        function pickOnMap(r, i) {
            pickMode = true;
            pickTarget = {r: r, i: i};
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('picker-banner').style.display = 'block';
        }

        function addStop() {
            let r = document.getElementById('route-select').value;
            schedules[r].push({n: "NOWY", t: "00:00", la: 51.93, ln: 15.54});
            loadEditor();
        }
        
        function delStop(r, i) { if(confirm("UsunƒÖƒá?")) { schedules[r].splice(i, 1); loadEditor(); } }
        function saveAndExit() { document.getElementById('admin-panel').style.display = 'none'; renderButtons(); updateScreen(); }
        
        function genGithub() {
            let code = "let schedules = " + JSON.stringify(schedules, null, 4) + ";";
            navigator.clipboard.writeText(code).then(() => alert("KOD SKOPIOWANY! ZastƒÖp nim sekcjƒô 'let schedules' w pliku."));
        }

    </script>
</body>
</html>
