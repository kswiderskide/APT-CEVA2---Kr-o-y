<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CEVA2 - Inteligentny Czas</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEq-AGhrBol0dkthbxNiH9MwSY-BMrD9s&libraries=geometry,directions"></script>

    <style>
        :root { --bg: #0b1120; --card: #1e293b; --blue: #38bdf8; --green: #22c55e; --red: #ef4444; --gold: #fbbf24; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        .nav-label { font-size: 0.8rem; color: #666; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; }
        .nav-row { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; flex-shrink: 0; }
        .btn-s { background: var(--card); color: #aaa; border: 1px solid #444; padding: 10px 14px; border-radius: 6px; font-weight: bold; white-space: nowrap; font-size: 0.9rem; }
        .btn-s.active { background: var(--blue); color: black; border-color: white; }

        .display { background: var(--card); border: 1px solid #334155; border-radius: 20px; padding: 12px; text-align: center; margin-bottom: 10px; flex-shrink: 0; }
        #stop-name { color: var(--blue); font-size: 1.6rem; font-weight: bold; margin: 0; text-transform: uppercase; }
        #timer { font-size: 3.8rem; font-weight: bold; margin: 2px 0; }
        #gps-msg { color: var(--gold); font-weight: bold; font-size: 1.1rem; }

        #map { flex: 1; width: 100%; border-radius: 15px; background: #111; margin-bottom: 10px; border: 2px solid var(--blue); }

        .footer { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 70px; margin-bottom: 5px; flex-shrink: 0; }
        .btn-nav { background: var(--card); color: white; border: 1px solid #444; border-radius: 15px; font-size: 1.1rem; font-weight: bold; }
        #btn-next { border: 2px solid var(--blue); color: var(--blue); }
        
        button:active { opacity: 0.7; }
    </style>
</head>
<body>

    <div class="nav-label">Do pracy:</div>
    <div class="nav-row" id="work-bar"></div>

    <div class="nav-label">Powroty:</div>
    <div class="nav-row" id="return-bar"></div>

    <div class="display">
        <div id="stop-name">CZEKAJ...</div>
        <div id="timer">--</div>
        <div id="gps-msg">GPS: Oczekiwanie...</div>
    </div>

    <div id="map"></div>

    <div class="footer">
        <button class="btn-nav" onclick="move(-1)">POPRZEDNI</button>
        <button class="btn-nav" id="btn-next" onclick="move(1)">NASTĘPNY</button>
    </div>

<script>
    var schedules = {
        "06:00": [ { "n": "RACULKA", "t": "04:47", "la": 51.93288, "ln": 15.54993 }, { "n": "WAZÓW", "t": "04:55", "la": 51.94536, "ln": 15.52031 }, { "n": "CENTRUM", "t": "04:58", "la": 51.94313, "ln": 15.50797 }, { "n": "SOBKOWIAKA", "t": "05:05", "la": 51.96132, "ln": 15.49857 }, { "n": "SULECHÓW", "t": "05:25", "la": 52.08334, "ln": 15.62666 }, { "n": "BRAMA 1", "t": "05:50", "la": 52.09099, "ln": 15.64957 }, { "n": "BRAMA 2", "t": "06:00", "la": 52.0941, "ln": 15.66049 } ],
        "10:00": [ { "n": "RACULKA", "t": "08:47", "la": 51.93288, "ln": 15.54993 }, { "n": "WAZÓW", "t": "08:55", "la": 51.94536, "ln": 15.52031 }, { "n": "CENTRUM", "t": "08:58", "la": 51.94313, "ln": 15.50797 }, { "n": "SOBKOWIAKA", "t": "09:05", "la": 51.96132, "ln": 15.49857 }, { "n": "SULECHÓW", "t": "09:25", "la": 52.08334, "ln": 15.62666 }, { "n": "BRAMA 1", "t": "09:50", "la": 52.09099, "ln": 15.64957 }, { "n": "BRAMA 2", "t": "10:00", "la": 52.0941, "ln": 15.66049 } ],
        "12:00": [ { "n": "RACULKA", "t": "10:40", "la": 51.93288, "ln": 15.54993 }, { "n": "WAZÓW", "t": "10:50", "la": 51.94536, "ln": 15.52031 }, { "n": "CENTRUM", "t": "10:53", "la": 51.94313, "ln": 15.50797 }, { "n": "SOBKOWIAKA", "t": "11:00", "la": 51.96132, "ln": 15.49857 }, { "n": "SULECHÓW", "t": "11:25", "la": 52.08334, "ln": 15.62666 }, { "n": "BRAMA 1", "t": "11:50", "la": 52.09099, "ln": 15.64957 }, { "n": "BRAMA 2", "t": "12:00", "la": 52.0941, "ln": 15.66049 } ],
        "14:00": [ { "n": "RACULKA", "t": "12:35", "la": 51.93288, "ln": 15.54993 }, { "n": "WAZÓW", "t": "12:45", "la": 51.94536, "ln": 15.52031 }, { "n": "CENTRUM", "t": "12:48", "la": 51.94313, "ln": 15.50797 }, { "n": "SOBKOWIAKA", "t": "13:00", "la": 51.96132, "ln": 15.49857 }, { "n": "SULECHÓW", "t": "13:25", "la": 52.08334, "ln": 15.62666 }, { "n": "BRAMA 1", "t": "13:50", "la": 52.09099, "ln": 15.64957 }, { "n": "BRAMA 2", "t": "14:00", "la": 52.0941, "ln": 15.66049 } ],
        "16:00": [ { "n": "RACULKA", "t": "14:35", "la": 51.93288, "ln": 15.54993 }, { "n": "WAZÓW", "t": "14:45", "la": 51.94536, "ln": 15.52031 }, { "n": "CENTRUM", "t": "14:48", "la": 51.94313, "ln": 15.50797 }, { "n": "SOBKOWIAKA", "t": "15:00", "la": 51.96132, "ln": 15.49857 }, { "n": "SULECHÓW", "t": "15:25", "la": 52.08334, "ln": 15.62666 }, { "n": "BRAMA 1", "t": "15:50", "la": 52.09099, "ln": 15.64957 }, { "n": "BRAMA 2", "t": "16:00", "la": 52.0941, "ln": 15.66049 } ],
        "18:00": [ { "n": "RACULKA", "t": "16:35", "la": 51.93288, "ln": 15.54993 }, { "n": "WAZÓW", "t": "16:45", "la": 51.94536, "ln": 15.52031 }, { "n": "CENTRUM", "t": "16:48", "la": 51.94313, "ln": 15.50797 }, { "n": "SOBKOWIAKA", "t": "17:00", "la": 51.96132, "ln": 15.49857 }, { "n": "SULECHÓW", "t": "17:25", "la": 52.08334, "ln": 15.62666 }, { "n": "BRAMA 1", "t": "17:50", "la": 52.09099, "ln": 15.64957 }, { "n": "BRAMA 2", "t": "18:00", "la": 52.0941, "ln": 15.66049 } ],
        "08:15": [ { "n": "BRAMA 2", "t": "08:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "10:15": [ { "n": "BRAMA 2", "t": "10:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "12:15": [ { "n": "BRAMA 2", "t": "12:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "14:15": [ { "n": "BRAMA 2", "t": "14:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "16:15": [ { "n": "BRAMA 2", "t": "16:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "18:15": [ { "n": "BRAMA 2", "t": "18:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "20:15": [ { "n": "BRAMA 2", "t": "20:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ],
        "22:15": [ { "n": "BRAMA 2", "t": "22:15", "la": 52.0941, "ln": 15.66049 }, { "n": "BRAMA 1", "t": "---", "la": 52.09099, "ln": 15.64957 }, { "n": "SULECHÓW", "t": "---", "la": 52.08334, "ln": 15.62666 }, { "n": "RACULKA", "t": "---", "la": 51.93288, "ln": 15.54993 } ]
    };

    var curr = "06:00", idx = 0, map, ds, dr, userPos, liveDelay = 0;

    window.onload = function() { renderNav(); refresh(); initMap(); setInterval(refresh, 1000); };

    function initMap() {
        if(typeof google === 'undefined') return;
        map = new google.maps.Map(document.getElementById("map"), { center: {lat: 51.93, lng: 15.54}, zoom: 14, mapTypeId: 'satellite', disableDefaultUI: true });
        map.addListener("click", function() {
            var s = schedules[curr][idx];
            window.open("https://www.google.com/maps/dir/?api=1&destination=" + s.la + "," + s.ln + "&travelmode=driving", "_blank");
        });
        ds = new google.maps.DirectionsService();
        dr = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                userPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                calc();
            }, null, { enableHighAccuracy: true });
        }
    }

    function calc() {
        if(!userPos || !ds) return;
        var s = schedules[curr][idx];
        ds.route({ origin: userPos, destination: {lat: s.la, lng: s.ln}, travelMode: 'DRIVING' }, (res, stat) => {
            if(stat === 'OK') { dr.setDirections(res); liveDelay = Math.round(res.routes[0].legs[0].duration.value / 60); }
        });
    }

    function refresh() {
        var s = schedules[curr][idx];
        document.getElementById('stop-name').innerText = s.n;
        var bn = document.getElementById('btn-next');
        bn.innerText = (idx >= schedules[curr].length - 1) ? "KONIEC ✅" : "NASTĘPNY";

        var timerEl = document.getElementById('timer');

        if(s.t === "---") {
            var now = new Date(); now.setMinutes(now.getMinutes() + liveDelay);
            timerEl.innerText = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
            timerEl.style.color = var(--blue);
            document.getElementById('gps-msg').innerText = "DOJAZD: " + liveDelay + " min";
        } else {
            var p = s.t.split(':'); var target = new Date(); target.setHours(p[0], p[1], 0);
            var diff = Math.ceil((target - new Date()) / 60000);
            
            // --- LOGIKA 90 MINUT ---
            if (diff < -90) { 
                diff += 1440; // Przeskocz na jutro dopiero po półtorej godziny spóźnienia
            }
            
            timerEl.innerText = diff + " min";
            
            // Kolorowanie: Czerwony jeśli minęła godzina (ale jeszcze nie przeskoczyło na jutro)
            if (diff < 0) {
                timerEl.style.color = "var(--red)";
            } else {
                timerEl.style.color = "var(--green)";
            }

            document.getElementById('gps-msg').innerText = "DO RUSZENIA: " + (diff - liveDelay) + " min";
        }
    }

    function move(d) {
        if(d === 1 && idx >= schedules[curr].length - 1) location.reload();
        else if(schedules[curr][idx + d]) { idx += d; refresh(); calc(); }
    }

    function renderNav() {
        var w = document.getElementById('work-bar');
        var r = document.getElementById('return-bar');
        w.innerHTML = ""; r.innerHTML = "";
        for(var k in schedules) {
            var btn = document.createElement('button');
            btn.className = 'btn-s' + (k === curr ? ' active' : '');
            btn.innerText = k;
            btn.onclick = (function(v){ return function(){ curr=v; idx=0; renderNav(); refresh(); calc(); }; })(k);
            if(k.includes(":00")) { w.appendChild(btn); }
            else { r.appendChild(btn); }
        }
    }
</script>
</body>
</html>
