<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>APT - Ceva2</title>

    <link rel="icon" type="image/png" href="njob.png">
    <link rel="apple-touch-icon" href="njob.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"APT - Ceva2","short_name":"APT - Ceva2","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000","icons":[{"src":"njob.png","sizes":"192x192","type":"image/png"}]}'>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMdnd3kjfS9rZJodhNclNPffa1Vn2DV5I&libraries=geometry,directions"></script>

    <style>
        :root { --bg: #000; --card: #1e293b; --blue: #38bdf8; --green: #22c55e; --red: #ef4444; --gold: #fbbf24; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; position: relative; }
        
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #splash h1 { color: #ddd; font-size: 2.5rem; font-weight: 900; letter-spacing: 3px; background: #444; padding: 20px 40px; border-radius: 20px; text-transform: uppercase; text-align: center; }
        .btn-start { background: transparent; color: var(--blue); border: 3px solid var(--blue); padding: 20px 80px; border-radius: 50px; font-size: 1.6rem; font-weight: 900; cursor: pointer; margin-top: 30px; }

        #dim-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0; pointer-events: none; transition: opacity 1.5s ease; z-index: 9000; }

        #map-container { position: relative; flex: 1; width: 100%; border-radius: 15px; overflow: hidden; border: 2px solid #334155; margin-bottom: 8px; }
        #map { width: 100%; height: 100%; background: #111; }

        #maneuver-panel { 
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.85); border: 2px solid var(--blue); border-radius: 12px; 
            padding: 10px; display: flex; align-items: center; gap: 15px; 
            min-height: 65px; z-index: 500; backdrop-filter: blur(5px);
        }
        #maneuver-dist { font-size: 1.8rem; font-weight: 900; color: var(--gold); white-space: nowrap; }
        #maneuver-text { font-size: 0.95rem; font-weight: bold; color: #fff; line-height: 1.2; }

        .btn-side { position: absolute; right: 15px; width: 44px; height: 44px; border: 2px solid white; border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        #exit-btn { top: 90px; background: var(--red); font-size: 24px; font-weight: bold; }
        #mute-btn { top: 145px; background: var(--blue); font-size: 20px; }

        .nav-label { font-size: 0.75rem; color: var(--blue); font-weight: 900; margin: 2px 0; text-transform: uppercase; }
        .nav-row { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; flex-shrink: 0; margin-right: 60px; }
        .btn-s { background: var(--card); color: #fff; border: 1px solid #444; padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; min-width: 55px; }
        .btn-s.active { background: var(--blue); color: black; border-color: white; }

        .display { background: var(--card); border: 2px solid #334155; border-radius: 15px; padding: 8px; text-align: center; margin-bottom: 5px; flex-shrink: 0; }
        #stop-name { color: var(--blue); font-size: 1.1rem; font-weight: 900; margin: 0; }
        .timer-container { display: flex; justify-content: center; align-items: baseline; gap: 10px; }
        #timer { font-size: 2.8rem; font-weight: 900; color: var(--green); }
        .gps-sub { font-size: 1.3rem; font-weight: 900; color: var(--blue); }

        #speed-panel { background: rgba(30, 41, 59, 0.9); border: 1px solid var(--gold); border-radius: 10px; padding: 4px; text-align: center; margin-bottom: 5px; flex-shrink: 0; }
        #speed-val { font-size: 2.2rem; font-weight: 900; color: var(--gold); }

        .footer { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 50px; margin-bottom: 30px; flex-shrink: 0; }
        .btn-nav { background: var(--card); color: white; border: 1px solid #444; border-radius: 12px; font-size: 1rem; font-weight: bold; }
    </style>
</head>
<body onclick="resetActivity()" ontouchstart="resetActivity()">

    <div id="splash">
        <h1>APT - Ceva2</h1>
        <button class="btn-start" onclick="startApp()">START</button>
    </div>

    <div id="dim-overlay"></div>

    <button id="exit-btn" class="btn-side" onclick="exitApp()">Ã—</button>
    <button id="mute-btn" class="btn-side" onclick="toggleMute()">ðŸ”ˆ</button>

    <div class="nav-label">ðŸ”µ WYJAZDY:</div>
    <div id="work-bar" class="nav-row"></div>
    <div class="nav-label">ðŸ”µ POWROTY:</div>
    <div id="return-bar" class="nav-row"></div>

    <div class="display">
        <div id="stop-name">WYBIERZ KURS</div>
        <div class="timer-container">
            <div id="timer">--</div>
            <div class="gps-sub" id="gps-timer">--</div>
        </div>
        <div id="gps-msg" style="color: var(--gold); font-size: 0.8rem; font-weight: bold;">ZAPAS: --</div>
    </div>

    <div id="speed-panel"><span id="speed-val">0</span> <small style="color:#aaa">km/h</small></div>

    <div id="map-container">
        <div id="maneuver-panel">
            <div id="maneuver-dist">---</div>
            <div id="maneuver-text">Czekam na GPS...</div>
        </div>
        <div id="map"></div>
    </div>

    <div class="footer">
        <button class="btn-nav" onclick="move(-1)">Wstecz</button>
        <button class="btn-nav" id="btn-next" style="color:var(--blue)" onclick="handleStep()">Dalej</button>
    </div>

<script>
    var schedules = {
        // WYJAZDY
        "6:00": [ { "n": "RACULKA", "t": "04:47", "la": 51.9213, "ln": 15.5562 }, { "n": "WAZÃ“W ZG", "t": "04:55", "la": 51.9366, "ln": 15.5133 }, { "n": "CENTRUM ZG", "t": "04:58", "la": 51.9388, "ln": 15.5055 }, { "n": "SOBKOWIAKA", "t": "05:05", "la": 51.9566, "ln": 15.5155 }, { "n": "SULECHÃ“W PCK", "t": "05:25", "la": 52.0833, "ln": 15.6255 }, { "n": "CEVA 2 BRAMA 2", "t": "---", "la": 52.094107, "ln": 15.660497 } ],
        "10:00": [ { "n": "RACULKA", "t": "08:47", "la": 51.9213, "ln": 15.5562 }, { "n": "WAZÃ“W ZG", "t": "08:55", "la": 51.9366, "ln": 15.5133 }, { "n": "CENTRUM ZG", "t": "08:58", "la": 51.9388, "ln": 15.5055 }, { "n": "SOBKOWIAKA", "t": "09:05", "la": 51.9566, "ln": 15.5155 }, { "n": "SULECHÃ“W PCK", "t": "09:25", "la": 52.0833, "ln": 15.6255 }, { "n": "CEVA 2 BRAMA 2", "t": "---", "la": 52.094107, "ln": 15.660497 } ],
        "12:00": [ { "n": "RACULKA", "t": "10:40", "la": 51.9213, "ln": 15.5562 }, { "n": "WAZÃ“W ZG", "t": "10:50", "la": 51.9366, "ln": 15.5133 }, { "n": "CENTRUM ZG", "t": "10:53", "la": 51.9388, "ln": 15.5055 }, { "n": "SOBKOWIAKA", "t": "11:00", "la": 51.9566, "ln": 15.5155 }, { "n": "SULECHÃ“W PCK", "t": "11:25", "la": 52.0833, "ln": 15.6255 }, { "n": "CEVA 2 BRAMA 2", "t": "---", "la": 52.094107, "ln": 15.660497 } ],
        "14:00": [ { "n": "RACULKA", "t": "12:35", "la": 51.9213, "ln": 15.5562 }, { "n": "WAZÃ“W ZG", "t": "12:45", "la": 51.9366, "ln": 15.5133 }, { "n": "CENTRUM ZG", "t": "12:48", "la": 51.9388, "ln": 15.5055 }, { "n": "SOBKOWIAKA", "t": "13:00", "la": 51.9566, "ln": 15.5155 }, { "n": "SULECHÃ“W PCK", "t": "13:25", "la": 52.0833, "ln": 15.6255 }, { "n": "CEVA 2 BRAMA 2", "t": "---", "la": 52.094107, "ln": 15.660497 } ],
        "16:00": [ { "n": "RACULKA", "t": "14:35", "la": 51.9213, "ln": 15.5562 }, { "n": "WAZÃ“W ZG", "t": "14:45", "la": 51.9366, "ln": 15.5133 }, { "n": "CENTRUM ZG", "t": "14:48", "la": 51.9388, "ln": 15.5055 }, { "n": "SOBKOWIAKA", "t": "15:00", "la": 51.9566, "ln": 15.5155 }, { "n": "SULECHÃ“W PCK", "t": "15:25", "la": 52.0833, "ln": 15.6255 }, { "n": "CEVA 2 BRAMA 2", "t": "---", "la": 52.094107, "ln": 15.660497 } ],
        "18:00": [ { "n": "RACULKA", "t": "16:35", "la": 51.9213, "ln": 15.5562 }, { "n": "WAZÃ“W ZG", "t": "16:45", "la": 51.9366, "ln": 15.5133 }, { "n": "CENTRUM ZG", "t": "16:48", "la": 51.9388, "ln": 15.5055 }, { "n": "SOBKOWIAKA", "t": "17:00", "la": 51.9566, "ln": 15.5155 }, { "n": "SULECHÃ“W PCK", "t": "17:25", "la": 52.0833, "ln": 15.6255 }, { "n": "CEVA 2 BRAMA 2", "t": "---", "la": 52.094107, "ln": 15.660497 } ],

        // POWROTY (Bez 6:15)
        "10:15": [ { "n": "CEVA 2 BRAMA 2", "t": "10:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ],
        "12:15": [ { "n": "CEVA 2 BRAMA 2", "t": "12:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ],
        "14:15": [ { "n": "CEVA 2 BRAMA 2", "t": "14:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ],
        "16:15": [ { "n": "CEVA 2 BRAMA 2", "t": "16:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ],
        "18:15": [ { "n": "CEVA 2 BRAMA 2", "t": "18:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ],
        "20:15": [ { "n": "CEVA 2 BRAMA 2", "t": "20:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ],
        "22:15": [ { "n": "CEVA 2 BRAMA 2", "t": "22:15", "la": 52.094107, "ln": 15.660497 }, { "n": "SULECHÃ“W PCK", "t": "---", "la": 52.0833, "ln": 15.6255 }, { "n": "SOBKOWIAKA", "t": "---", "la": 51.9566, "ln": 15.5155 }, { "n": "CENTRUM ZG", "t": "---", "la": 51.9388, "ln": 15.5055 }, { "n": "WAZÃ“W ZG", "t": "---", "la": 51.9366, "ln": 15.5133 }, { "n": "RACULKA", "t": "---", "la": 51.9213, "ln": 15.5562 } ]
    };

    var curr = "6:00", idx = 0, map, ds, dr, userPos, liveDelay = 0, wakeLock = null;
    var userMarker, isMuted = false, lastSirenTime = 0, lastActivity = Date.now(), nextManeuverDistValue = 9999; 

    function resetActivity() {
        lastActivity = Date.now();
        document.getElementById('dim-overlay').style.opacity = '0';
        const doc = document.documentElement;
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            if (doc.requestFullscreen) doc.requestFullscreen();
            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        }
    }

    function checkDimming() {
        if ((Date.now() - lastActivity > 15000) && nextManeuverDistValue > 300) {
            document.getElementById('dim-overlay').style.opacity = '0.7';
        } else {
            document.getElementById('dim-overlay').style.opacity = '0';
        }
    }

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }

    function autoSelectShift() {
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();
        let found = "6:00";
        const keys = Object.keys(schedules).sort();
        for (let k of keys) {
            const [h, m] = schedules[k][0].t.split(':').map(Number);
            if (h * 60 + m > curMin) { found = k; break; }
        }
        curr = found;
    }

    function startApp() {
        autoSelectShift(); requestWakeLock();
        document.getElementById('exit-btn').style.display = 'flex';
        document.getElementById('mute-btn').style.display = 'flex';
        document.getElementById('splash').style.opacity = '0';
        setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 500);
        renderNav(); initMap(); initGPS(); calc();
        setInterval(calc, 60000); setInterval(refresh, 1000); setInterval(checkDimming, 1000);
    }

    function initGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                userPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                document.getElementById('speed-val').innerText = (p.coords.speed && p.coords.speed > 0) ? Math.round(p.coords.speed * 3.6) : 0;
                if (map) {
                    map.panTo(userPos);
                    if (p.coords.heading !== null) map.setHeading(p.coords.heading);
                    if (userMarker) userMarker.setPosition(userPos);
                    else userMarker = new google.maps.Marker({ position: userPos, map: map, icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale: 7, fillColor: "#38bdf8", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 } });
                }
                let d = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userPos.lat, userPos.lng), new google.maps.LatLng(schedules[curr][idx].la, schedules[curr][idx].ln));
                if (d < 150 && idx < schedules[curr].length - 1) { idx++; calc(); refresh(); }
            }, null, { enableHighAccuracy: true });
        }
    }

    function initMap() {
        if(typeof google === 'undefined') return;
        map = new google.maps.Map(document.getElementById("map"), { center: {lat: 51.93, lng: 15.50}, zoom: 17, mapTypeId: 'roadmap', tilt: 45, heading: 0, disableDefaultUI: true, gestureHandling: 'greedy' });
        new google.maps.TrafficLayer().setMap(map);
        ds = new google.maps.DirectionsService(); dr = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
    }

    function calc() {
        if(!userPos || !ds) return;
        ds.route({ origin: userPos, destination: {lat: schedules[curr][idx].la, lng: schedules[curr][idx].ln}, travelMode: google.maps.TravelMode.DRIVING }, (res, stat) => {
            if(stat === 'OK') { 
                dr.setDirections(res); 
                liveDelay = Math.round((res.routes[0].legs[0].duration.value / 60) * 1.16);
                let step = res.routes[0].legs[0].steps[0];
                nextManeuverDistValue = step.distance.value;
                document.getElementById('maneuver-dist').innerText = step.distance.text;
                document.getElementById('maneuver-text').innerHTML = step.instructions;
            }
        });
    }

    function refresh() {
        let s = schedules[curr][idx];
        document.getElementById('stop-name').innerText = s.n;
        let tEl = document.getElementById('timer');
        let gtEl = document.getElementById('gps-timer');
        gtEl.innerText = formatClock(liveDelay);
        if(s.t === "---") {
            let n = new Date(); n.setMinutes(n.getMinutes() + liveDelay);
            tEl.innerText = n.getHours() + ":" + (n.getMinutes()<10?'0':'') + n.getMinutes();
            tEl.style.color = "var(--blue)"; gtEl.style.display = "none";
        } else {
            gtEl.style.display = "block";
            let p = s.t.split(':'); let tr = new Date(); tr.setHours(p[0], p[1], 0);
            let diff = Math.ceil((tr - new Date()) / 60000);
            if (diff < -90) diff += 1440;
            tEl.innerText = formatClock(diff);
            tEl.style.color = (diff < 0) ? "var(--red)" : "var(--green)";
            let zap = diff - liveDelay;
            document.getElementById('gps-msg').innerText = "ZAPAS: " + formatClock(zap);
            if (zap === 1 && !isMuted && (Date.now() - lastSirenTime > 60000)) { triggerSiren(); lastSirenTime = Date.now(); }
        }
    }

    function triggerSiren() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination); osc.type = 'triangle';
        osc.frequency.setValueAtTime(400, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(900, ctx.currentTime + 0.3);
        osc.start(); osc.stop(ctx.currentTime + 0.7);
    }

    function formatClock(totalMin) {
        if (totalMin < 0) return totalMin + " min";
        let h = Math.floor(totalMin / 60); let m = totalMin % 60;
        return (h > 0 ? h + "h " : "") + (m < 10 && h > 0 ? "0" + m : m) + "m";
    }

    function renderNav() {
        let w = document.getElementById('work-bar'); let r = document.getElementById('return-bar');
        w.innerHTML = ""; r.innerHTML = "";
        const workHours = ["6:00", "10:00", "12:00", "14:00", "16:00", "18:00"];
        for(let k in schedules) {
            let b = document.createElement('button');
            b.className = 'btn-s' + (k === curr ? ' active' : '');
            b.innerText = k;
            b.onclick = (e) => { e.stopPropagation(); curr = k; idx = 0; renderNav(); calc(); refresh(); };
            if(workHours.includes(k)) w.appendChild(b); else r.appendChild(b);
        }
    }

    function toggleMute() { isMuted = !isMuted; document.getElementById('mute-btn').innerText = isMuted ? "ðŸ”‡" : "ðŸ”ˆ"; }
    function exitApp() { if(confirm("ZakoÅ„czyÄ‡ trasÄ™?")) { if(wakeLock) wakeLock.release(); location.reload(); } }
    function move(d) { if(schedules[curr][idx + d]) { idx += d; calc(); refresh(); } }
    function handleStep() { if (idx < schedules[curr].length - 1) { idx++; calc(); refresh(); } else exitApp(); }
</script>
</body>
</html>
