<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>APT CEVA2</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEq-AGhrBol0dkthbxNiH9MwSY-BMrD9s&libraries=geometry,directions"></script>
    
    <style>
        :root {
            --bg: #0b1120; --card: #1e293b; --blue: #38bdf8;
            --green: #22c55e; --red: #ef4444; --gold: #fbbf24; --text: #f8fafc;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 6px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        /* EKRAN STARTOWY */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .start-btn { width: 180px; height: 180px; border-radius: 50%; background: var(--blue); color: white; border: none; font-size: 2rem; font-weight: 900; box-shadow: 0 0 30px rgba(56, 189, 248, 0.4); }
        .start-gear { position: absolute; bottom: 30px; right: 30px; font-size: 1.5rem; background: var(--card); border: 1px solid #334155; padding: 15px; border-radius: 50%; opacity: 0.6; }

        /* KLAWIATURA PIN */
        #pin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 30000; flex-direction: column; justify-content: center; align-items: center; }
        .pin-dots { font-size: 3rem; color: var(--blue); margin-bottom: 20px; height: 50px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 75px); gap: 15px; }
        .key { width: 75px; height: 75px; background: var(--card); border: 1px solid #334155; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.6rem; font-weight: 800; }

        /* PANEL EDYCJI */
        #admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; padding: 12px; overflow-y: auto; box-sizing: border-box; }
        .edit-row { background: var(--card); border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 1px solid #334155; position: relative; }
        .edit-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 5px; }
        .edit-coords { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 8px; }
        .edit-input { background: #0f172a; border: 1px solid var(--blue); color: white; padding: 8px; border-radius: 5px; font-size: 0.8rem; width: 100%; box-sizing: border-box; }
        .del-btn { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: 900; z-index: 5; }
        .map-pick-btn { background: var(--blue); color: white; border: none; border-radius: 5px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* BANNER WYBORU Z MAPY */
        #map-picker-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: var(--gold); color: black; padding: 15px; text-align: center; font-weight: 900; z-index: 40000; font-size: 0.9rem; }

        /* UI G≈Å√ìWNE */
        .shift-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 8px; }
        .btn-s { background: var(--card); border: 1px solid #334155; color: #94a3b8; padding: 8px 14px; border-radius: 8px; white-space: nowrap; font-size: 0.75rem; font-weight: 800; }
        .btn-s.active { background: var(--blue); color: white; }
        .display-area { flex: 3; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--card); border-radius: 25px; margin-bottom: 8px; border: 2px solid #334155; position: relative; }
        #stop-name { font-size: 2.3rem; font-weight: 900; color: var(--blue); text-align: center; line-height: 1; margin: 0 10px; }
        #main-min { font-size: 4.8rem; font-weight: 900; margin: 5px 0; }
        #gps-min { font-size: 3rem; font-weight: 900; color: var(--gold); }
        #map-container { flex: 2; border-radius: 20px; overflow: hidden; border: 2px solid var(--blue); position: relative; cursor: pointer; }
        #map { width: 100%; height: 100%; }
        .grid-two { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .tile-big { background: var(--card); border-radius: 15px; height: 60px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.2rem; border: 1px solid #334155; }
    </style>
</head>
<body>

    <div id="map-picker-banner">KLIKNIJ NA MAPIE, ABY USTALIƒÜ MIEJSCE</div>

    <div id="start-overlay">
        <button class="start-btn" onclick="startApp()">START</button>
        <div class="start-gear" onclick="openPin()">‚öôÔ∏è</div>
    </div>

    <div id="pin-overlay">
        <p style="font-weight:900;">PIN ADMINISTRATORA</p>
        <div class="pin-dots" id="pin-dots"></div>
        <div class="keypad">
            <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
            <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
            <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
            <div class="key" style="color:var(--red)" onclick="clearPin()">C</div><div class="key" onclick="pressKey('0')">0</div><div class="key" onclick="closePin()">‚úñ</div>
        </div>
    </div>

    <div id="admin-panel">
        <h2 style="color:var(--blue); margin-bottom: 10px;">EDYCJA TRASY</h2>
        <select id="route-select" onchange="loadRouteToEdit()" style="width:100%; padding:12px; margin-bottom:15px; background:var(--card); color:white; border-radius:10px; border: 1px solid var(--blue);"></select>
        
        <div id="stops-edit-list"></div>

        <button onclick="addNewStop()" style="width:100%; padding:15px; background:var(--blue); color:white; border:none; border-radius:10px; font-weight:900; margin-bottom:20px;">+ DODAJ PRZYSTANEK</button>
        
        <button onclick="saveAndClose()" style="width:100%; padding:20px; background:var(--green); color:white; border:none; border-radius:15px; font-weight:900; margin-bottom:10px;">ZAPISZ I WR√ìƒÜ</button>
        <button onclick="exportCode()" style="width:100%; padding:15px; background:var(--gold); color:black; border:none; border-radius:15px; font-weight:900; margin-bottom:10px;">GENERUJ KOD GITHUB</button>
        <button onclick="closeAdmin()" style="width:100%; padding:12px; background:var(--red); color:white; border:none; border-radius:15px;">WYJD≈π</button>
    </div>

    <div class="shift-nav" id="shift-nav-all"></div>

    <div class="display-area">
        <p id="stop-name">CZEKAJ...</p>
        <div id="main-min">-- min</div>
        <div id="gps-min">-- min</div>
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <div class="grid-two">
        <div class="tile-big" onclick="move(-1)">‚¨ÖÔ∏è WSTECZ</div>
        <div id="btn-next" class="tile-big" onclick="move(1)" style="border-color:var(--blue)">DALEJ ‚û°Ô∏è</div>
    </div>

    <script>
        const ADMIN_PASS = "1234";
        let currentPin = "";
        let schedules = {
            "06:00": [{n:"RACULKA",t:"04:47",la:51.93288,ln:15.54993},{n:"WAZ√ìW",t:"04:55",la:51.94536,ln:15.52031},{n:"CENTRUM",t:"04:58",la:51.94313,ln:15.50797},{n:"SOBKOWIAKA",t:"05:05",la:51.96132,ln:15.49857},{n:"SULECH√ìW",t:"05:25",la:52.08334,ln:15.62666},{n:"BRAMA 1",t:"05:50",la:52.09099,ln:15.64957},{n:"BRAMA 2",t:"06:00",la:52.09410,ln:15.66049}],
            "POWR√ìT 22:15": [{n:"BRAMA 2 (START)",t:"22:15",la:52.09410,ln:15.66049},{n:"BRAMA 1",t:"---",la:52.09099,ln:15.64957},{n:"SULECH√ìW",t:"---",la:52.08334,ln:15.62666},{n:"RACULKA",t:"---",la:51.93288,ln:15.54993}]
        };

        let currShift = "06:00"; let idx = 0; let userPos = null;
        let map, directionsService, directionsRenderer, liveDur = 0;
        let pickingMode = false; let pickingTarget = {route: "", index: 0};

        function startApp() { document.getElementById('start-overlay').style.display='none'; renderNav(); initMap(); startGps(); setInterval(tick, 1000); }

        function openPin() { document.getElementById('pin-overlay').style.display = 'flex'; currentPin = ""; updatePinDots(); }
        function closePin() { document.getElementById('pin-overlay').style.display = 'none'; }
        function clearPin() { currentPin = ""; updatePinDots(); }
        function updatePinDots() { document.getElementById('pin-dots').innerText = "‚Ä¢".repeat(currentPin.length); }
        function pressKey(num) {
            currentPin += num; updatePinDots();
            if(currentPin.length === 4) {
                if(currentPin === ADMIN_PASS) { closePin(); openAdmin(); }
                else { alert("B≈ÅƒòDNY PIN"); clearPin(); }
            }
        }

        function openAdmin() {
            document.getElementById('admin-panel').style.display = 'block';
            const sel = document.getElementById('route-select'); sel.innerHTML = "";
            Object.keys(schedules).forEach(k => { sel.innerHTML += `<option value="${k}">${k}</option>`; });
            loadRouteToEdit();
        }

        function loadRouteToEdit() {
            const r = document.getElementById('route-select').value; const b = document.getElementById('stops-edit-list'); b.innerHTML = "";
            schedules[r].forEach((s, i) => {
                b.innerHTML += `
                <div class="edit-row">
                    <button class="del-btn" onclick="removeStop('${r}', ${i})">X</button>
                    <div class="edit-grid">
                        <input class="edit-input" placeholder="Nazwa" value="${s.n}" onchange="schedules['${r}'][${i}].n=this.value">
                        <input class="edit-input" placeholder="HH:MM" value="${s.t}" onchange="schedules['${r}'][${i}].t=this.value">
                    </div>
                    <div class="edit-coords">
                        <input class="edit-input" id="lat-${i}" type="number" step="any" value="${s.la}" onchange="schedules['${r}'][${i}].la=parseFloat(this.value)">
                        <input class="edit-input" id="lng-${i}" type="number" step="any" value="${s.ln}" onchange="schedules['${r}'][${i}].ln=parseFloat(this.value)">
                        <button class="map-pick-btn" onclick="enterPickerMode('${r}', ${i})">üìç</button>
                    </div>
                </div>`;
            });
        }

        // TRYB KLIKANIA W MAPƒò
        function enterPickerMode(route, index) {
            pickingMode = true;
            pickingTarget = {route, index};
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('map-picker-banner').style.display = 'block';
            // Pozw√≥l na klikanie w mapƒô (usu≈Ñ pointer-events: none je≈õli by≈Ço)
            document.getElementById('map').style.pointerEvents = "auto";
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), { 
                center: {lat:51.93, lng:15.54}, 
                zoom: 14, 
                mapTypeId: 'satellite', 
                disableDefaultUI: true,
                gestureHandling: 'greedy'
            });
            
            // S≈ÅUCHACZ KLIKNIƒòƒÜ W MAPƒò
            map.addListener('click', (e) => {
                if(pickingMode) {
                    const lat = e.latLng.lat().toFixed(6);
                    const lng = e.latLng.lng().toFixed(6);
                    
                    schedules[pickingTarget.route][pickingTarget.index].la = parseFloat(lat);
                    schedules[pickingTarget.route][pickingTarget.index].ln = parseFloat(lng);
                    
                    pickingMode = false;
                    document.getElementById('map-picker-banner').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    loadRouteToEdit();
                } else {
                    // Je≈õli nie wybieramy punktu, otw√≥rz normalnƒÖ nawigacjƒô
                    openNavi();
                }
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#38bdf8', strokeWeight: 6 } });
            userMarker = new google.maps.Marker({ map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#fff', fillOpacity: 1, strokeColor: '#38bdf8', strokeWeight: 2 } });
        }

        function addNewStop() {
            const r = document.getElementById('route-select').value;
            schedules[r].push({n:"NOWY", t:"00:00", la: 51.93, ln: 15.54});
            loadRouteToEdit();
        }

        function removeStop(r, i) {
            if(confirm("UsunƒÖƒá ten przystanek?")) { schedules[r].splice(i, 1); loadRouteToEdit(); }
        }

        function saveAndClose() { document.getElementById('admin-panel').style.display = 'none'; renderNav(); tick(); }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
        function exportCode() { 
            const code = "let schedules = " + JSON.stringify(schedules, null, 4) + ";";
            navigator.clipboard.writeText(code).then(() => alert("KOD SKOPIOWANY!"));
        }

        function startGps() {
            navigator.geolocation.watchPosition(pos => {
                userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                if(userMarker) userMarker.setPosition(userPos);
                updateETA();
            }, null, { enableHighAccuracy: true });
        }

        function updateETA() {
            if(!userPos || pickingMode) return;
            const dest = {lat: schedules[currShift][idx].la, lng: schedules[currShift][idx].ln};
            directionsService.route({ origin: userPos, destination: dest, travelMode: 'DRIVING' }, (res, stat) => {
                if (stat === 'OK') { directionsRenderer.setDirections(res); liveDur = Math.round(res.routes[0].legs[0].duration.value / 60); }
            });
        }

        function tick() {
            if(pickingMode) return;
            const s = schedules[currShift][idx]; if(!s) return;
            document.getElementById('stop-name').innerText = s.n;
            const btn = document.getElementById('btn-next');
            if(idx === schedules[currShift].length - 1) { btn.innerText = "ZAKO≈ÉCZ ‚úÖ"; btn.style.background = "var(--green)"; }
            else { btn.innerText = "DALEJ ‚û°Ô∏è"; btn.style.background = "var(--card)"; }

            if (s.t === "---") {
                const eta = new Date(); eta.setMinutes(eta.getMinutes() + liveDur);
                document.getElementById('main-min').innerText = eta.getHours() + ":" + String(eta.getMinutes()).padStart(2,'0');
                document.getElementById('gps-min').innerText = liveDur + " min";
                document.getElementById('main-min').style.color = "var(--blue)";
            } else {
                const [h, m] = s.t.split(':').map(Number); const plan = new Date(); plan.setHours(h, m, 0);
                const diff = Math.ceil((plan - new Date()) / 60000);
                document.getElementById('main-min').innerText = diff + " min";
                document.getElementById('main-min').style.color = diff < 0 ? 'var(--red)' : 'var(--green)';
                document.getElementById('gps-min').innerText = (diff - liveDur) + " min";
            }
        }

        function renderNav() {
            const nav = document.getElementById('shift-nav-all'); nav.innerHTML = "";
            Object.keys(schedules).forEach(k => {
                const b = document.createElement('button'); b.className = 'btn-s'; if(k === currShift) b.classList.add('active');
                b.innerText = k; b.onclick = () => { currShift = k; idx = 0; renderNav(); updateETA(); };
                nav.appendChild(b);
            });
        }

        function move(d) { if (schedules[currShift][idx + d]) { idx += d; updateETA(); } else if (d===1) location.reload(); }
        function openNavi() { 
            if(pickingMode) return;
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${schedules[currShift][idx].la},${schedules[currShift][idx].ln}&travelmode=driving`, '_blank'); 
        }
    </script>
</body>
</html>
