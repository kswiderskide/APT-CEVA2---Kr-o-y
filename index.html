<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CEVA2 Dashboard - Multi Navi</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMdnd3kjfS9rZJodhNclNPffa1Vn2DV5I&libraries=geometry,directions"></script>
    
    <style>
        :root {
            --bg: #0b1120; --card: #1e293b; --blue: #38bdf8;
            --green: #22c55e; --red: #ef4444; --gold: #fbbf24; --text: #f8fafc;
        }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 8px; display: flex; flex-direction: column; height: 100vh; 
            box-sizing: border-box; overflow: hidden;
        }
        
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 9999; }
        .animate-flash { animation: flash-seq 0.6s ease-in-out 5; }
        @keyframes flash-seq { 0%, 100% { opacity: 0; } 50% { opacity: 0.7; background: var(--gold); } }

        /* Menu wyboru nawigacji */
        #navi-selector {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 17, 32, 0.95); flex-direction: column; justify-content: center;
            align-items: center; z-index: 10000;
        }
        .navi-option {
            width: 80%; background: var(--card); border: 2px solid #334155; color: white;
            padding: 18px; margin: 8px; border-radius: 15px; font-weight: 800; font-size: 1.1rem;
            text-align: center; cursor: pointer;
        }
        .navi-option:active { background: var(--blue); }

        .nav-label { font-size: 0.65rem; font-weight: 900; color: #64748b; text-transform: uppercase; margin: 2px 0 2px 5px; }
        .shift-nav { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 6px; flex-shrink: 0; scrollbar-width: none; }
        .btn-s { background: var(--card); border: 1px solid #334155; color: #94a3b8; padding: 8px 14px; border-radius: 10px; white-space: nowrap; font-weight: 800; font-size: 0.75rem; }
        .btn-s.active { background: var(--blue); border-color: var(--blue); color: #fff; }

        .display-area { flex: 3; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--card); border-radius: 24px; margin-bottom: 8px; border: 2px solid #334155; position: relative; overflow: hidden; }
        
        #stop-name { font-size: 1.8rem; font-weight: 900; color: var(--blue); margin-bottom: 10px; text-transform: uppercase; text-align: center; width: 95%; line-height: 1.1; }
        .label-text { font-size: 0.85rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: -5px; }
        #main-min { font-size: 4.5rem; font-weight: 900; line-height: 1; margin-bottom: 10px; display: flex; align-items: baseline; }
        #gps-min { font-size: 3.2rem; font-weight: 900; color: var(--gold); line-height: 1; display: flex; align-items: baseline; }
        .unit { font-size: 1.2rem; margin-left: 5px; font-weight: 700; opacity: 0.8; }

        #map-container { flex: 1.2; min-height: 120px; border-radius: 20px; overflow: hidden; border: 2px solid var(--blue); position: relative; cursor: pointer; }
        #map { width: 100%; height: 100%; pointer-events: none; }

        .grid-two { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); }
        .tile-big { background: var(--card); border-radius: 20px; height: 65px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.1rem; color: white; border: 1px solid #334155; }

        #mute-btn { position: absolute; top: 10px; right: 15px; font-size: 1.4rem; background: none; border: none; z-index: 10; }
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .start-btn { background: var(--blue); color: white; border: none; padding: 25px 50px; border-radius: 50px; font-weight: 900; font-size: 1.8rem; }
    </style>
</head>
<body>

    <div id="flash-overlay"></div>
    
    <div id="start-overlay">
        <button class="start-btn" onclick="startApp()">START</button>
    </div>

    <div id="navi-selector">
        <p style="font-weight: 900; margin-bottom: 20px;">WYBIERZ NAWIGACJƒò:</p>
        <div class="navi-option" onclick="launchNav('google')">GOOGLE MAPS</div>
        <div class="navi-option" onclick="launchNav('waze')">WAZE</div>
        <div class="navi-option" onclick="launchNav('apple')">APPLE MAPS (iOS)</div>
        <div class="navi-option" onclick="launchNav('system')">DOMY≈öLNA SYSTEMOWA</div>
        <div style="margin-top:20px; color:#94a3b8; text-decoration: underline;" onclick="closeNavSelector()">ANULUJ</div>
    </div>

    <div class="nav-label">Do pracy:</div>
    <div class="shift-nav" id="shift-nav-work"></div>
    <div class="nav-label">Powroty:</div>
    <div class="shift-nav" id="shift-nav-returns"></div>

    <div class="display-area">
        <button id="mute-btn" onclick="toggleMute(event)">üîä</button>
        <p id="stop-name">CZEKAJ...</p>
        <span class="label-text">Do odjazdu:</span>
        <div id="main-min">--<span class="unit">min</span></div>
        <span class="label-text" style="color: var(--gold)">Musisz ruszyƒá za:</span>
        <div id="gps-min">--<span class="unit">min</span></div>
    </div>

    <div id="map-container" onclick="showNavSelector()">
        <div id="map"></div>
        <div style="position: absolute; top: 5px; right: 10px; font-size: 0.6rem; color: #fff; background: rgba(0,0,0,0.5); padding: 2px 5px; border-radius: 4px;">KLIKNIJ BY NAWIGOWAƒÜ</div>
    </div>

    <div class="grid-two">
        <div class="tile-big" onclick="move(-1)">‚¨ÖÔ∏è WSTECZ</div>
        <div class="tile-big" onclick="move(1)" style="border-color: var(--blue);">DALEJ ‚û°Ô∏è</div>
    </div>

    <script>
        let currShift = "06:00"; let idx = 0; let userPos = null;
        let isMuted = false; let map, userMarker, directionsService, directionsRenderer;
        let liveDurationMinutes = 0; let moveAlarmPlayed = false; let departureAlarmPlayed = false;

        const geo = { 
            r: {lat: 51.932880, lng: 15.549931}, w: {lat: 51.945368, lng: 15.520318}, 
            c: {lat: 51.943136, lng: 15.507973}, s: {lat: 51.961328, lng: 15.498570}, 
            sul: {lat: 52.083341, lng: 15.626667}, b1: {lat: 52.091677, lng: 15.651582}, 
            b2: {lat: 52.094107, lng: 15.660497}  
        };

        const schedules = {
            "06:00": [{n:"RACULKA",t:"04:47",g:geo.r},{n:"WAZ√ìW",t:"04:55",g:geo.w},{n:"CENTRUM",t:"04:58",g:geo.c},{n:"SOBKOWIAKA",t:"05:05",g:geo.s},{n:"SULECH√ìW",t:"05:25",g:geo.sul},{n:"BRAMA 1",t:"05:50",g:geo.b1},{n:"BRAMA 2",t:"06:00",g:geo.b2}],
            "10:00": [{n:"RACULKA",t:"08:47",g:geo.r},{n:"WAZ√ìW",t:"08:55",g:geo.w},{n:"CENTRUM",t:"08:58",g:geo.c},{n:"SOBKOWIAKA",t:"09:05",g:geo.s},{n:"SULECH√ìW",t:"09:25",g:geo.sul},{n:"BRAMA 1",t:"09:50",g:geo.b1},{n:"BRAMA 2",t:"10:00",g:geo.b2}],
            "12:00": [{n:"RACULKA",t:"10:40",g:geo.r},{n:"WAZ√ìW",t:"10:50",g:geo.w},{n:"CENTRUM",t:"10:53",g:geo.c},{n:"SOBKOWIAKA",t:"11:00",g:geo.s},{n:"SULECH√ìW",t:"11:25",g:geo.sul},{n:"BRAMA 1",t:"11:50",g:geo.b1},{n:"BRAMA 2",t:"12:00",g:geo.b2}],
            "14:00": [{n:"RACULKA",t:"12:35",g:geo.r},{n:"WAZ√ìW",t:"12:45",g:geo.w},{n:"CENTRUM",t:"12:48",g:geo.c},{n:"SOBKOWIAKA",t:"13:00",g:geo.s},{n:"SULECH√ìW",t:"13:25",g:geo.sul},{n:"BRAMA 1",t:"13:50",g:geo.b1},{n:"BRAMA 2",t:"14:00",g:geo.b2}],
            "16:00": [{n:"RACULKA",t:"14:35",g:geo.r},{n:"WAZ√ìW",t:"14:45",g:geo.w},{n:"CENTRUM",t:"14:48",g:geo.c},{n:"SOBKOWIAKA",t:"15:00",g:geo.s},{n:"SULECH√ìW",t:"15:25",g:geo.sul},{n:"BRAMA 1",t:"15:50",g:geo.b1},{n:"BRAMA 2",t:"16:00",g:geo.b2}],
            "18:00": [{n:"RACULKA",t:"16:35",g:geo.r},{n:"WAZ√ìW",t:"16:45",g:geo.w},{n:"CENTRUM",t:"16:48",g:geo.c},{n:"SOBKOWIAKA",t:"17:00",g:geo.s},{n:"SULECH√ìW",t:"17:25",g:geo.sul},{n:"BRAMA 1",t:"17:50",g:geo.b1},{n:"BRAMA 2",t:"18:00",g:geo.b2}],
            "POWR√ìT 10:15": [{n:"BRAMA 2 (START)",t:"10:15",g:geo.b2},{n:"BRAMA 1",t:"---",g:geo.b1},{n:"SULECH√ìW",t:"---",g:geo.sul},{n:"RACULKA",t:"---",g:geo.r}],
            "POWR√ìT 14:15": [{n:"BRAMA 2 (START)",t:"14:15",g:geo.b2},{n:"BRAMA 1",t:"---",g:geo.b1},{n:"SULECH√ìW",t:"---",g:geo.sul},{n:"RACULKA",t:"---",g:geo.r}],
            "POWR√ìT 22:15": [{n:"BRAMA 2 (START)",t:"22:15",g:geo.b2},{n:"BRAMA 1",t:"---",g:geo.b1},{n:"SULECH√ìW",t:"---",g:geo.sul},{n:"RACULKA",t:"---",g:geo.r}]
        };

        function showNavSelector() { document.getElementById('navi-selector').style.display = 'flex'; }
        function closeNavSelector() { document.getElementById('navi-selector').style.display = 'none'; }

        function launchNav(type) {
            if (!userPos) { alert("Czekam na GPS..."); return; }
            const currentSchedule = schedules[currShift];
            const remainingStops = currentSchedule.slice(idx);
            const nextStop = remainingStops[0];
            const lastStop = remainingStops[remainingStops.length - 1];
            
            let url = "";
            switch(type) {
                case 'google':
                    const waypointsArr = remainingStops.slice(0, -1).map(s => `${s.g.lat},${s.g.lng}`);
                    const waypoints = waypointsArr.length > 0 ? `&waypoints=${waypointsArr.join('|')}` : "";
                    url = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${lastStop.g.lat},${lastStop.g.lng}${waypoints}&travelmode=driving`;
                    break;
                case 'waze':
                    url = `https://waze.com/ul?ll=${nextStop.g.lat},${nextStop.g.lng}&navigate=yes`;
                    break;
                case 'apple':
                    url = `maps://?daddr=${nextStop.g.lat},${nextStop.g.lng}&saddr=${userPos.lat},${userPos.lng}`;
                    break;
                case 'system':
                    url = `geo:${nextStop.g.lat},${nextStop.g.lng}?q=${nextStop.g.lat},${nextStop.g.lng}(${nextStop.n})`;
                    break;
            }
            window.open(url, '_blank');
            closeNavSelector();
        }

        function startApp() {
            const doc = window.document.documentElement; if (doc.requestFullscreen) doc.requestFullscreen().catch(() => {});
            document.getElementById('start-overlay').style.display = 'none'; initMap(); startGps(); setInterval(tick, 1000); 
        }

        function triggerVisualFlash() {
            const overlay = document.getElementById('flash-overlay');
            overlay.classList.remove('animate-flash'); void overlay.offsetWidth; overlay.classList.add('animate-flash');
        }

        function initMap() {
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#38bdf8', strokeWeight: 6 } });
            map = new google.maps.Map(document.getElementById("map"), { center: schedules[currShift][0].g, zoom: 16, mapTypeId: 'satellite', disableDefaultUI: true });
            directionsRenderer.setMap(map);
            userMarker = new google.maps.Marker({ position: schedules[currShift][0].g, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: '#fff', fillOpacity: 1, strokeColor: '#38bdf8', strokeWeight: 2 } });
        }

        function startGps() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    if (userMarker) userMarker.setPosition(userPos); if (map) map.panTo(userPos);
                    updateLiveETA();
                }, null, { enableHighAccuracy: true });
            }
        }

        function updateLiveETA() {
            if (userPos && directionsService) {
                directionsService.route({ origin: userPos, destination: schedules[currShift][idx].g, travelMode: 'DRIVING' }, (res, stat) => {
                    if (stat === 'OK') { directionsRenderer.setDirections(res); liveDurationMinutes = Math.round(res.routes[0].legs[0].duration.value / 60); }
                });
            }
        }

        function tick() {
            const s = schedules[currShift][idx]; if(!s) return;
            document.getElementById('stop-name').innerText = s.n;
            if (s.t === "---") { document.getElementById('main-min').innerHTML = '--<span class="unit">min</span>'; document.getElementById('gps-min').innerHTML = '--<span class="unit">min</span>'; return; }
            const now = new Date(); const [h, m] = s.t.split(':').map(Number); const plan = new Date(); plan.setHours(h, m, 0); const diff = Math.ceil((plan - now) / 60000);
            const disp = document.getElementById('main-min'); disp.innerHTML = diff + '<span class="unit">min</span>'; disp.style.color = diff < 0 ? 'var(--red)' : 'var(--green)';
            if (diff === 0 && !departureAlarmPlayed) { triggerVisualFlash(); departureAlarmPlayed = true; }
            const moveIn = diff - liveDurationMinutes; const moveDisp = document.getElementById('gps-min');
            if (moveIn <= 0) { moveDisp.innerHTML = 'RUSZAJ!'; moveDisp.style.color = 'var(--red)'; } 
            else { moveDisp.innerHTML = moveIn + '<span class="unit">min</span>'; moveDisp.style.color = 'var(--gold)'; if (moveIn <= 3 && !moveAlarmPlayed && !currShift.startsWith("POWR√ìT")) { triggerVisualFlash(); moveAlarmPlayed = true; } }
        }

        function move(d) { if (schedules[currShift][idx + d]) { idx += d; moveAlarmPlayed = false; departureAlarmPlayed = false; updateLiveETA(); tick(); } }
        function toggleMute() { isMuted = !isMuted; document.getElementById('mute-btn').innerText = isMuted ? "üîá" : "üîä"; }

        window.onload = () => {
            const navWork = document.getElementById('shift-nav-work'), navReturns = document.getElementById('shift-nav-returns');
            Object.keys(schedules).forEach((k) => {
                const b = document.createElement('button'); b.className = 'btn-s'; if (k === currShift) b.classList.add('active'); b.innerText = k.replace("POWR√ìT ", "");
                b.onclick = () => { document.querySelectorAll('.btn-s').forEach(x => x.classList.remove('active')); b.classList.add('active'); currShift = k; idx = 0; moveAlarmPlayed = false; departureAlarmPlayed = false; updateLiveETA(); tick(); };
                if (k.startsWith("POWR√ìT")) navReturns.appendChild(b); else navWork.appendChild(b);
            });
        };
    </script>
</body>
</html>